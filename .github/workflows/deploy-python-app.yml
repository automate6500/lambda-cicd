name: 2-Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

# Required for OIDC
permissions:
  id-token: write
  contents: read

jobs:
  # ------------------------------------------------------------
  # Integration: reuse your existing integration workflow
  # ------------------------------------------------------------
  Integrate:
    name: Integrate
    uses: ./.github/workflows/integrate-python-app.yml
    permissions:
      contents: read
      checks: write

  # ------------------------------------------------------------
  # Delivery: build lambda.zip and publish as an artifact
  # ------------------------------------------------------------
  Build:
    needs: Integrate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.0

      - name: Set up Python environment with caching enabled for pip dependencies
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install the project requirements
        run: make requirements

      # Build the code and create a lambda.zip artifact
      - name: Create the lambda.zip artifact
        run: make build

      - name: Archive lambda.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-artifact
          path: ./lambda.zip
          retention-days: 7

  # ------------------------------------------------------------
  # Deploy to Staging: continuous deployment on each push
  # ------------------------------------------------------------
  Staging:
    name: Deploy to Staging
    environment:
      name: Staging
      url: ${{ vars.URL }}
    needs: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.0

      - name: Set up Python environment with caching enabled for pip dependencies
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install the project requirements
        run: make requirements

      # OIDC (no long-lived access keys)
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}

      - name: Retrieve lambda.zip
        uses: actions/download-artifact@v4
        with:
          name: lambda-artifact

      - name: Deploy
        run: |
          make deploy \
            PLATFORM="GitHub Actions" \
            FUNCTION="${{ vars.FUNCTION_NAME }}" \
            VERSION="${GITHUB_SHA}" \
            BUILD_NUMBER="${GITHUB_RUN_NUMBER}"

      - name: Test deployment
        run: |
          make testdeployment URL=${{ vars.URL }} VERSION=${GITHUB_SHA}

  # ------------------------------------------------------------
  # Deploy to Production: gated by manual approval (environment reviewers)
  # ------------------------------------------------------------
  Production:
    name: Deploy to Production (Approval Required)
    needs: Staging
    environment:
      name: Production
      url: ${{ vars.URL }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.0

      - name: Set up Python environment with caching enabled for pip dependencies
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install the project requirements
        run: make requirements

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}

      - name: Retrieve lambda.zip
        uses: actions/download-artifact@v4
        with:
          name: lambda-artifact

      - name: Deploy
        run: |
          make deploy \
            PLATFORM="GitHub Actions" \
            FUNCTION="${{ vars.FUNCTION_NAME }}" \
            VERSION="${GITHUB_SHA}" \
            BUILD_NUMBER="${GITHUB_RUN_NUMBER}"

      - name: Test deployment
        run: |
          make testdeployment URL=${{ vars.URL }} VERSION=${GITHUB_SHA}
